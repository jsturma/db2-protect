[[root@db2 db2-protect]# su - db2inst1 -c 'bash -x /opt/db2-protect/backup-db2.sh'
+ set -euo pipefail
+++ dirname /opt/db2-protect/backup-db2.sh
++ cd /opt/db2-protect
++ pwd
+ SCRIPT_DIR=/opt/db2-protect
+ PROJECT_ROOT=/opt/db2-protect
+ CONFIG_FILE=/opt/db2-protect/etc/backup-config.yaml
+ LOG_DIR=/opt/db2-protect/logs
+ mkdir -p /opt/db2-protect/logs
+ LOG_DIR=/home/db2inst1/db2-protect-logs
+ mkdir -p /home/db2inst1/db2-protect-logs
+ mkdir -p /home/db2inst1/db2-protect-logs
+ LOG_FILE=/home/db2inst1/db2-protect-logs/db2-backup.log
+ date +%N
+ date +%N
+ grep -q '[0-9]'
++ date +%Y%m%d_%H%M%S
++ date +%N
++ head -c 3
+ TIMESTAMP=20251121_143121092
+ main
+ log INFO '=== DB2 Backup Started ==='
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] === DB2 Backup Started ==='
+ echo '[2025-11-21 14:31:21] [INFO] === DB2 Backup Started ==='
[2025-11-21 14:31:21] [INFO] === DB2 Backup Started ===
+ echo '[2025-11-21 14:31:21] [INFO] === DB2 Backup Started ==='
+ setup_db2_user
++ whoami
+ local current_user=db2inst1
+ [[ db2inst1 == \r\o\o\t ]]
+ DB2_USER=db2inst1
+ log INFO 'DB2 user: db2inst1'
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] DB2 user: db2inst1'
+ echo '[2025-11-21 14:31:21] [INFO] DB2 user: db2inst1'
[2025-11-21 14:31:21] [INFO] DB2 user: db2inst1
+ echo '[2025-11-21 14:31:21] [INFO] DB2 user: db2inst1'
+ check_db2
+ [[ db2inst1 == \r\o\o\t ]]
+ [[ -z db2inst1 ]]
+ db2_cmd 'command -v db2'
+ log INFO 'DB2 found for user db2inst1'
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] DB2 found for user db2inst1'
+ echo '[2025-11-21 14:31:21] [INFO] DB2 found for user db2inst1'
[2025-11-21 14:31:21] [INFO] DB2 found for user db2inst1
+ echo '[2025-11-21 14:31:21] [INFO] DB2 found for user db2inst1'
+ load_config
+ [[ -f /opt/db2-protect/etc/backup-config.yaml ]]
+ log INFO 'Loading config: /opt/db2-protect/etc/backup-config.yaml'
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] Loading config: /opt/db2-protect/etc/backup-config.yaml'
+ echo '[2025-11-21 14:31:21] [INFO] Loading config: /opt/db2-protect/etc/backup-config.yaml'
[2025-11-21 14:31:21] [INFO] Loading config: /opt/db2-protect/etc/backup-config.yaml
+ echo '[2025-11-21 14:31:21] [INFO] Loading config: /opt/db2-protect/etc/backup-config.yaml'
++ parse_yaml /opt/db2-protect/etc/backup-config.yaml config_
+++ echo @
+++ tr @ '\034'
++ local p=config_ 's=[[:space:]]*' 'w=[a-zA-Z0-9_]*' $'fs=\034'
++ sed -ne 's|^\([[:space:]]*\):|\1|' -e 's|^\([[:space:]]*\)\([a-zA-Z0-9_]*\)[[:space:]]*:[[:space:]]*["'\'']\(.*\)["'\''][[:space:]]*$|\1\2\3|p' -e 's|^\([[:space:]]*\)\([a-zA-Z0-9_]*\)[[:space:]]*:[[:space:]]*\(.*\)[[:space:]]*$|\1\2\3|p' /opt/db2-protect/etc/backup-config.yaml
++ awk $'-F\034' '{indent=length($1)/2;vname[indent]=$2;for(i in vname){if(i>indent)delete vname[i]}
        if(length($3)>0){vn="";for(i=0;i<indent;i++)vn=(vn)(vname[i])("_");printf("%s%s%s=\"%s\"\n","config_",vn,$2,$3);}}'
+ eval 'config_backup_type="full"' 'config_compress="true"' 'config_parallelism="4"' 'config_buffer_size="1024"' 'config_backup_path="/mnt/backup/db2"' 'config_db_instance="db2inst1"' 'config_db_name="SAMPLE"' 'config_connection_type="local' '#' local, cataloged, or 'non-cataloged"' 'config_retention_days="30"'
++ config_backup_type=full
++ config_compress=true
++ config_parallelism=4
++ config_buffer_size=1024
++ config_backup_path=/mnt/backup/db2
++ config_db_instance=db2inst1
++ config_db_name=SAMPLE
++ config_connection_type='local # local, cataloged, or non-cataloged'
++ config_retention_days=30
+ BACKUP_TYPE=full
+ COMPRESS=true
+ PARALLELISM=4
+ BUFFER_SIZE=1024
+ BACKUP_PATH=/mnt/backup/db2
+ DB_INSTANCE=db2inst1
+ DB_NAME=SAMPLE
++ echo 'local # local, cataloged, or non-cataloged'
++ tr '[:upper:]' '[:lower:]'
++ xargs
+ CONNECTION_TYPE='local # local, cataloged, or non-cataloged'
+ DB_HOST=
+ DB_PORT=50000
+ DB_USER=
+ DB_PASSWORD=
+ [[ -n /mnt/backup/db2 ]]
+ [[ local # local, cataloged, or non-cataloged != \l\o\c\a\l ]]
+ IS_EXTERNAL_CLIENT=true
+ [[ local # local, cataloged, or non-cataloged == \n\o\n\-\c\a\t\a\l\o\g\e\d ]]
+ log INFO 'Config: type=full path=/mnt/backup/db2 conn=local # local, cataloged, or non-cataloged db=SAMPLE'
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] Config: type=full path=/mnt/backup/db2 conn=local # local, cataloged, or non-cataloged db=SAMPLE'
+ echo '[2025-11-21 14:31:21] [INFO] Config: type=full path=/mnt/backup/db2 conn=local # local, cataloged, or non-cataloged db=SAMPLE'
[2025-11-21 14:31:21] [INFO] Config: type=full path=/mnt/backup/db2 conn=local # local, cataloged, or non-cataloged db=SAMPLE
+ echo '[2025-11-21 14:31:21] [INFO] Config: type=full path=/mnt/backup/db2 conn=local # local, cataloged, or non-cataloged db=SAMPLE'
+ check_mount_point /mnt/backup/db2
+ local mp=/mnt/backup/db2
+ [[ true == \t\r\u\e ]]
+ log WARN 'Path /mnt/backup/db2 must be accessible from DB2 server: server'
+ local l=WARN
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [WARN] Path /mnt/backup/db2 must be accessible from DB2 server: server'
+ echo '[2025-11-21 14:31:21] [WARN] Path /mnt/backup/db2 must be accessible from DB2 server: server'
[2025-11-21 14:31:21] [WARN] Path /mnt/backup/db2 must be accessible from DB2 server: server
+ echo '[2025-11-21 14:31:21] [WARN] Path /mnt/backup/db2 must be accessible from DB2 server: server'
+ [[ /mnt/backup/db2 =~ ^/ ]]
+ return 0
+ connect_db2
+ [[ true == \t\r\u\e ]]
+ connect_external_client
+ log INFO 'Connecting as external client...'
+ local l=INFO
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [INFO] Connecting as external client...'
+ echo '[2025-11-21 14:31:21] [INFO] Connecting as external client...'
[2025-11-21 14:31:21] [INFO] Connecting as external client...
+ echo '[2025-11-21 14:31:21] [INFO] Connecting as external client...'
+ [[ local # local, cataloged, or non-cataloged == \c\a\t\a\l\o\g\e\d ]]
+ [[ local # local, cataloged, or non-cataloged == \n\o\n\-\c\a\t\a\l\o\g\e\d ]]
+ [[ -n '' ]]
+ error_exit 'Invalid connection_type: local # local, cataloged, or non-cataloged'
+ log ERROR 'Invalid connection_type: local # local, cataloged, or non-cataloged'
+ local l=ERROR
+ shift
++ date '+%Y-%m-%d %H:%M:%S'
+ local 'msg=[2025-11-21 14:31:21] [ERROR] Invalid connection_type: local # local, cataloged, or non-cataloged'
+ echo '[2025-11-21 14:31:21] [ERROR] Invalid connection_type: local # local, cataloged, or non-cataloged'
[2025-11-21 14:31:21] [ERROR] Invalid connection_type: local # local, cataloged, or non-cataloged
+ echo '[2025-11-21 14:31:21] [ERROR] Invalid connection_type: local # local, cataloged, or non-cataloged'
+ exit 1
[root@db2 db2-protect]#
